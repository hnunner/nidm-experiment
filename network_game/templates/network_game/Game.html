<style>
    .otree-body.container {
        margin-left: 10px;
        margin-top: -40px;
    }
</style>

{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
    Choose your network ties!
{% endblock %}

{% block content %}

    <!-- p>Your are participant {{ participant.id_in_session }}.</p -->
    <input type="hidden" name="ties_form_req_options" />
    <input type="hidden" name="ties_form_res_options" />
    <input type="hidden" name="ties_rem_options" />
    <input type="hidden" name="ties_form_req_selected" />
    <input type="hidden" name="ties_form_res_selected" />
    <input type="hidden" name="ties_rem_selected">


    <!--            TABLE LAYOUT            -->
    <table>
        <tr>
            <td valign="top">
                <div id="nidm_network"></div>
            </td>
            <td valign="top">
                <div id="form-ties"></div>
            </td>
        </tr>
    </table>


    <!--        NETWORK PRESENTATION        -->
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style type="text/css">
        #nidm_network {
            width: 800px;
            height: 600px;
            border: 1px solid lightgray;
        }
    </style>
    <script type="text/javascript">

        let p_id = Number(js_vars.p_id);
        let ties = js_vars.ties;
        let disease_states = js_vars.disease_states;
        let risk_perceptions = js_vars.risk_perceptions;

        // console.log("player ID: ".concat(p_id));
        // console.log("disease states: ".concat(disease_states));
        // for (let d in disease_states) {
        //     console.log(d)
        //     console.log(disease_states[d])
        // }
        // console.log("risk perceptions: ".concat(risk_perceptions));
        // for (let r in risk_perceptions) {
        //     console.log(r)
        //     console.log(risk_perceptions[r])
        // }
        // console.log("ties: ".concat(ties));
        // for (let t in ties) {
        //     console.log(t)
        //     console.log(ties[t])
        // }

        // create an array with nodes
        let nodes = new vis.DataSet();
        for (let d in disease_states) {
            if (disease_states.hasOwnProperty(d)) {
                d = Number(d);
                let ds = Number(disease_states[d]);
                let size = Number(risk_perceptions[d])*15;
                // node of player
                if (d ===  p_id) {
                    // susceptible
                    if (ds === 1) {
                        nodes.add({id: d, color: '#FFFFFF', shape: 'star', size: size})
                    // infected
                    } else if (ds === 2) {
                        nodes.add({id: d, color: '#000000', shape: 'star', size: size})
                    // recovered
                    } else if (ds === 3) {
                        nodes.add({id: d, color: '#888888', shape: 'star', size: size})
                    } else {
                        nodes.add({id: d, color: '#FFFFFF', shape: 'star', size: size})
                    }
                // nodes of other players
                } else {
                    // susceptible
                    if (ds === 1) {
                        nodes.add({id: d, label: d.toString(), color: '#FFFFFF', shape: 'hexagon', size: size})
                    // infected
                    } else if (ds === 2) {
                        nodes.add({id: d, label: d.toString(), color: '#000000', shape: 'hexagon', size: size})
                    // recovered
                    } else if (ds === 3) {
                        nodes.add({id: d, label: d.toString(), color: '#888888', shape: 'hexagon', size: size})
                    } else {
                        nodes.add({id: d, label: d.toString(), color: '#FFFFFF', shape: 'hexagon', size: size})
                    }
                }
            }
        }

        // create an array with edges
        let edges = new vis.DataSet();
        for (let src in ties) {
            if (ties.hasOwnProperty(src)) {
                src = Number(src);
                let ties_of_src = ties[src];
                for (let i = 0; i < ties_of_src.length; i++) {
                    let dest = Number(ties_of_src[i]);
                    edges.add({from: src, to: dest});
                }
            }
        }

        // create a network
        let container = document.getElementById('nidm_network');
        let data = {
            nodes: nodes,
            edges: edges
        };
        let options = {};
        let network = new vis.Network(container, data, options);
    </script>

    <!----------------------------------------------------------------------------------->
    <!------------------------- Form for tie formation requests ------------------------->
    <!----------------------------------------------------------------------------------->

    <script type="text/javascript">
        function createCheckboxForm(ties, title, breaks) {

            // create a form
            let f = document.createElement("form");
            // f.setAttribute('method', "post");
            // f.setAttribute('action', "submit.php");

            // create title
            f.appendChild(document.createTextNode(title));
            for (let b = 0; b < breaks; b++) {
                f.appendChild(document.createElement("br"));
            }

            // create checkboxes
            for (let t in ties) {
                // checkbox id
                let cb_id = "cb_".concat(ties[t]);

                // create a single checkbox
                let cb = document.createElement("input");
                cb.type = "checkbox";
                cb.id = cb_id;
                cb.name = cb_id;

                // create a label for the checkbox
                let lbl = document.createElement("Label");
                lbl.setAttribute("for", cb_id);
                lbl.appendChild(document.createTextNode("   ".concat(ties[t])));

                // create empty label as "whitespace hack"
                let ws = document.createTextNode("\t");

                // add all elements to the form
                f.appendChild(cb);
                f.appendChild(ws);
                f.appendChild(lbl);
                f.appendChild(document.createElement("br"));
            }
            return f;
        }

        let td_ties_form_req = document.createElement('td');
        let td_ties_form_res = document.createElement('td');
        let td_ties_rem = document.createElement('td');

        window.onload = function() {

            let p_id = Number(js_vars.p_id);
            let f_ties_form_req_options = createCheckboxForm(js_vars.ties_form_req_options[p_id], "Send tie formation request to:", 2);
            let f_ties_form_res_options = createCheckboxForm(js_vars.ties_form_res_options[p_id], "Accept tie formation request from:", 2);
            let f_ties_rem_options = createCheckboxForm(js_vars.ties_rem_options[p_id], "Break tie with:", 3);

            // create a table
            let tbl = document.createElement('table');
            tbl.setAttribute('align', 'center');
            tbl.setAttribute('border', '0');
            tbl.setAttribute('cellpadding', '10');
            tbl.setAttribute('width', '700');

            let tbdy = document.createElement('tbody');
            let tr = document.createElement('tr');

            td_ties_form_req.setAttribute('align', 'center');
            td_ties_form_req.setAttribute('valign', 'top');
            td_ties_form_req.setAttribute('width', '150');
            td_ties_form_req.appendChild(f_ties_form_req_options);
            tr.appendChild(td_ties_form_req);

            td_ties_form_res.setAttribute('align', 'center');
            td_ties_form_res.setAttribute('valign', 'top');
            td_ties_form_res.setAttribute('width', '150');
            td_ties_form_res.appendChild(f_ties_form_res_options);
            tr.appendChild(td_ties_form_res);

            td_ties_rem.setAttribute('align', 'center');
            td_ties_rem.setAttribute('valign', 'top');
            td_ties_rem.setAttribute('width', '150');
            td_ties_rem.appendChild(f_ties_rem_options);
            tr.appendChild(td_ties_rem);

            let td4 = document.createElement('td');
            td4.setAttribute('align', 'center');
            td4.setAttribute('bgcolor', '#AAAAAA');
            td4.setAttribute('padding-left', '40px');
            td4.setAttribute('valign', 'top');
            td4.setAttribute('width', '150');

            let title_res_prev_round =  document.createTextNode("Results of last round");
            let bold_res_title_prev_round = document.createElement('strong');
            bold_res_title_prev_round.appendChild(title_res_prev_round);
            td4.appendChild(bold_res_title_prev_round);
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createTextNode("Benefits of ties:"));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createTextNode("Costs of ties:"));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createTextNode("Disease penalty:"));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createTextNode("Earnings:"));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));

            let res_average =  document.createTextNode("Average earnings per round: ");
            let bold_res_average = document.createElement('strong');
            bold_res_average.appendChild(res_average);
            td4.appendChild(bold_res_average);
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));

            let res_total =  document.createTextNode("Total earnings: ");
            let bold_res_total = document.createElement('strong');
            bold_res_total.appendChild(res_total);
            td4.appendChild(bold_res_total);
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));
            td4.appendChild(document.createElement('br'));

            tr.appendChild(td4);

            tbdy.appendChild(tr);
            tbl.appendChild(tbdy);

            // add the form inside the body
            document.getElementById('form-ties').appendChild(tbl);
        }

        function isCheckbox (element) {
            return element instanceof HTMLInputElement && element.getAttribute('type') == 'checkbox';
        }

        window.onunload = function () {

            let p_id = Number(js_vars.p_id);

            let cbs_ties_form_req = td_ties_form_req.childNodes[0].childNodes;
            for (let cb in cbs_ties_form_req) {
                if (isCheckbox(cb)) {
                    if (cb.checked) {
                        js_vars.ties_form_req_selected[p_id].concat(cb.name);
                    }
                }
            }

            let cbs_ties_form_res = td_ties_form_res.childNodes[0].childNodes;
            for (let cb in cbs_ties_form_res) {
                if (isCheckbox(cb)) {
                    if (cb.checked) {
                        js_vars.ties_form_res_selected[p_id].concat(cb.name);
                    }
                }
            }

            let cbs_ties_rem = td_ties_rem.childNodes[0].childNodes;
            for (let cb in cbs_ties_rem) {
                if (isCheckbox(cb)) {
                    if (cb.checked) {
                        js_vars.ties_rem_selected[p_id].concat(cb.name);
                    }
                }
            }

        }
    </script>

    {{ form.ties_form_req_options.errors }}
    {{ form.ties_form_res_options.errors }}
    {{ form.ties_rem_options.errors }}
    {{ form.ties_form_req_selected.errors }}
    {{ form.ties_form_res_selected.errors }}
    {{ form.ties_rem_selected.errors }}

    <br>
    {% next_button %}

{% endblock %}
